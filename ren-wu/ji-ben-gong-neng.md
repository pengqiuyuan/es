#### 词包模块（单个监测项为一个词包计算子任务）

> **任务加载**

【1】词包任务主、次两张表创建（OneToMany 一对多）

```
stq_monitor_primary

id 主键
task_name 监测项任务名称
task_type 监测项任务分类。此监测项监测的数据源、微博（1）、微信（2）等等
excel_path 指标下载地址。当点击词包主任务页面的下载按钮时，首先根据主表 id 和 task_type 去 es或mongodb？ 获取对应指标文档，然后服务器生成excel文件
data_index 指标值（actualVolume，volume等等）。页面默认全部（除情感分析？），不可勾选。
data_index_name 指标值中文名称（实际声量，声量等等）。
cr_date 词包主任务生成时间
upd_date 词包主任务更新时间
status 词包主任务有效、无效。控制次表监测项任务的状态，停止对应的每个子任务。

stq_monitor_second

id 主键
primary_id 外键，stq_monitor_primary 表的主键
start_date 监测项任务起始时间
end_date 监测项任务结束时间
task_type 监测项任务分类。此监测项监测的数据源、微博（1）、微信（2）等等
key_word 监测项名称。如：三少爷的剑+电影+-测试1+-测试2+测试3+-测试4+中文加+-中文减||三少爷的剑+林更新||三少爷的剑+何润东||三少爷的剑+江一燕||三少爷的剑+蒋梦婕
cr_date 词包次任务生成时间
upd_date 词包次任务更新时间
status 词包次任务的运行状态，0（子任务未开始），1（子任务进行中），2（子任务已完成，完成以后立即保存指标到es对应索引），3（此子任务计算出错）
```

【2】页面添加单个监测项任务。（保存词包主、次任务表），返回一组主任务ID到前端页面，指标结果通过传入主ID获取。

3个jsp页面，2个controller，2个service，2个dao，测试结果。

```
页面传入参数
1、监测项名称，页面输入框提示输入格式。“||”为或，“+”为包含，“+-”为不包含，如：三少爷的剑+电影+-测试1+-测试2+测试3+-测试4+中文加+-中文减||三少爷的剑+林更新||三少爷的剑+何润东||三少爷的剑+江一燕||三少爷的剑+蒋梦婕
2、监测项起始时间
3、监测项结束时间
4、类型（监测数据的来源，如：微博、微信等等）
同时保持任务到词包主、次两张表
返回数组展示在前端页面：如：[1,2,3]，如果，每多选一个类型，数组多一个值。

注意：没有指标可以勾选。这里在服务层处理好，数据源类型的不同，需要计算的指标也不一样。
```

【3】Excel批量添加监测项任务。（保存词包主、次任务表），返回主任务ID到前端页面，指标结果通过传入主ID获取。

一个jsp页面，一个controller的方法，一个service的方法，测试结果。

```
一、需要Excel 文件的模板，供使用者下载。Excel列包括：监测项名称、监测起始时间、监测结束时间、数据源类型

二、页面传入参数
1、上传文件
2、选择类型（监测数据的来源，如：微博、微信等等）
同时保持任务到词包主、次两张表
返回数组展示在前端页面：如：[1,2,3]，如果，每多选一个类型，数组多一个值。

注意：没有指标可以勾选。这里在服务层处理好，数据源类型的不同，需要计算的指标也不一样。
```

【4】API ，客户端提交监测项任务集合，返回主任务ID。（保存词包主、次任务表），返回主任务ID到前端页面，指标结果通过传入（主ID+type）获取。

一个方法。

```
request 
keyword:如：三少爷的剑+电影+-测试1+-测试2+测试3+-测试4+中文加+-中文减||三少爷的剑+林更新||三少爷的剑+何润东||三少爷的剑+江一燕||三少爷的剑+蒋梦婕
type：微博（1）、微信（2）等等

{
    "taskList": [
        {
            "keyword": "三少爷的剑",
            "startDate": "2017-01-01",
            "endDate": "2017-01-02",
            "subDate": "0"
        },
        {
            "keyword": "电影",
            "startDate": "2017-01-01",
            "endDate": "2017-01-02",
            "subDate": "1"
        }
    ],
    "taskType": "weibo"
}

response 
primaryId：主任务ID

{
     "primaryId": "1"
}
```

> **任务处理（计算）**

【1】微博

实际声量，声量，互动量，转发深度（取最大值），原发提及占比，评论贡献比，点赞贡献比，二级及以上转发占比，三级及以上转发占比，**曝光量、独立账号占比，正面情绪占比，中立情绪占比，负面情绪占比，口碑值**

【2】微信

实际声量，声量，阅读量，点赞量，统计占比，**正面情绪占比，中立情绪占比，负面情绪占比，口碑值**

【3】百度新闻

【4】百度贴吧

【5】头条

【6】知乎问答

【7】天涯

> **指标保存**

【1】单个监测项任务计算结果的保存（Es或者mongodb）。每条文档都有，监测项名称，起始日期、结束日期，指标属于类别（微博、微信等等）

【2】按词包主ID+指标属于类别，按一定顺序，取出所有符合指标文档。

【3】按监测项名称、起始日期、结束日期、类别，一定顺序，取出所有符合指标文档。

> **结果取出**

【1】词包主任务页面，通过ID查询任务，点击下载，导出监测项Excel文件

```
1、词包主任务页面提供，一个通过ID查询主任务的功能，当所有子任务完成的时候，页面显示“下载地址”按钮，否则显示为“等待”
2、点击下载，去es或者mongodb？根据 主任务id+type，获取计算好的指标结果，写入服务器excel，生成对应地址。
```

【2】API ，客户端提交任务词包次ID，返回指标结果

```
request 

get ? primaryId=1

response

{
    "message":"",  //字符串
    "taskStatus","" //字符串
}
--------

{
    "message":"任务未开始",
    "taskStatus","0"
}

{
    "message":"任务进行中",
    "taskStatus","1"
}

{
    "message":"任务已完成，可以调用 findByKeywords 接口查询！",
    "taskStatus","2"
}

{
    "message":"任务执行错误！",
    "taskStatus","3"
}

{
    "message":"不存在 primaryId:1的任务",
    "taskStatus","3"
}
```

【3】API ，客户端通过传入参数，词包监测项名称、起始日期、结束日期、类别（微博、微信等等），返回指标结果

```
POST /findByKeywords

{
    "keyWord": "你的名字+电影",
    "startDate": "2016-11-02",
    "endDate": "2017-05-01",
    "subDate": "1",
    "taskType": "weibo"
}

response

[
    {
    "keywords": "你的名字+电影",
    "startDate": "2016-11-02",
    "endDate": "2016-11-03",
    "volume": "3183",
    "actualVolume": "90",
    "exposure": "8431368",
    "interactive": "781",
    "oldInteractive": "13969",
    "forwardDepth": "6"
    },
    ...
]

OR

[]
```

> 生产环境配置

JDK8+、Mysql、mongodb、Jetty、Nginx

词包模块（微博）: 预期时间2周

祖德：任务加载模块

新彪：与mongodb交互的部分的所有功能，指标数据的存、取相关接口方法。

秋源：微博指标计算、任务调度、Es相关功能的封装、公共模块的封装、指标结果返回的API

每天早上9：15-9：30，15分钟小会，各种总结前一天任务完成度。周五总结一次。统计计算模块

新增 production 分支，我们三人，保证本地代码不会和 production 有冲突的情况下，每天都必须把自己的 merge 到 production 分支。然后 production = merge &gt; master

---

词包模块修改：预计时间下周一或者周二能完成。提供给研究使用。

1、点击显示进度摁钮，任务为已完成时，直接显示为100%

2、新增、批量添加任务，主任务添加监测项名称，子任务添加监测项名称和监测项关键字。注意：次任务表结构修改+上传Excel包含字段的添加。

3、主任务下载功能（所有子任务计算指标下载），对不同数据源计算结果分sheet。

4、添加任务，监测项任务分类修改\(weibo  -&gt; weibo,weixin\) 等等。

5、任务调度计算开始，判断任务是否已计算过，如果查询Es有结果，说明任务已添加，并且有保存计算指标，不做重复计算，reture。

6、任务调度计算结束，判断任务执行是否已全部完成（主任务进度100%），为100%时自动生成查询生成Excel文件。主任务页面显示，可以点击下载。

7、API添加任务接口修改。

词包模块：2周

1、多数据源添加计算指标功能。

2、子任务监测项，不同数据源图表对比展示。



数据源分类

api

账号

微信计算

测试

cibao\_index

